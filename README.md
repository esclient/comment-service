# Comment Service

Микросервис для управления комментариями в системе esclient. Использует gRPC для взаимодействия между микросервисами и PostgreSQL для хранения данных.

## Содержание

- [Стек](#стек)
- [Архитектура](#архитектура)
- [Функциональность](#функциональность)
- [Установка и запуск](#установка-и-запуск)
- [Конфигурация](#конфигурация)
- [Разработка](#разработка)

### Основные возможности:
- Создание комментариев
- Редактирование комментариев
- Удаление комментариев
- Получение списка комментариев

## Стек

- **Python 3.13+** - основной язык разработки
- **gRPC** - межсервисное взаимодействие
- **PostgreSQL** - база данных
- **PDM** - управление зависимостями
- **Docker** - контейнеризация
- **dbmate** - SQL миграции БД (через Docker, без Python-кода)

## Архитектура

```
┌─────────────────┐
│   gRPC Handler  │  ← Обработка gRPC запросов
├─────────────────┤
│   Service Layer │  ← Бизнес-логика
├─────────────────┤
│ Repository Layer│  ← Работа с базой данных
├─────────────────┤
│   PostgreSQL    │  ← Хранение данных
└─────────────────┘
```

## Функциональность

### Создание комментария
- Проверка входных данных
- Сохранение в базу данных с автоматической датой создания
- Возврат ID созданного комментария

### Редактирование комментария
- Проверка существования комментария
- Обновление текста и времени редактирования
- Возврат статуса операции

### Удаление комментария
- Проверка существования комментария
- Удаление комментария
- Возврат статуса операции

### Получение комментариев
- Получение списка комментариев по ID мода

## Установка и запуск

### Требования
- Python 3.13+
- PDM (Python Dependency Manager)
- Make
- Protobuf (Protocol Buffer Compiler Installation)
- PostgreSQL
- Docker

### Локальная разработка

1. **Клонируем репу:**
```bash
git clone https://github.com/esclient/comment-service
cd comment-service
```

2. **Устанавливаем зависимости через pdm:**
```bash
pdm install
```
3. **Активируйте вирт. окружение (вирт. окружение pdm активирует сам)**

4. **Настройте окружение**

5. **Запустите Docker Desktop**

6. **Запустите сервер:**
```bash
make run
```

## Конфигурация

Сервис использует переменные окружения для конфигурации. Все настройки в файле `.env`:

```env
# Настройки базы данных
DATABASE_URL=postgresql://user:password@host:port/database

# Настройки сервера
HOST=0.0.0.0
PORT=7777

# Настройки логирования
LOG_LEVEL=INFO
LOG_FORMAT=%(asctime)s %(levelname)-8s [%(name)s] %(message)s
LOG_DATEFMT=%Y-%m-%d %H:%M:%S
```

### Описание параметров:

| Параметр | Описание | Пример |
|----------|----------|---------|
| `DATABASE_URL` | Строка подключения к PostgreSQL | `postgresql://user:pass@host:5432/db` |
| `HOST` | IP адрес для привязки сервера | `0.0.0.0` |
| `PORT` | Порт для gRPC сервера | `7777` |
| `LOG_LEVEL` | Уровень логирования | `INFO`, `DEBUG`, `WARNING` |

## Миграции базы данных (dbmate)

Для кросс-языкового подхода используется `dbmate` (SQL-файлы, без привязки к Python).

Предусловия:

- Установлен Docker
- Переменная `DATABASE_URL` задана, пример: `postgresql://user:pass@host:5432/db`.

Команды:

```bash
# Создать новую миграцию (имя опционально):
just migrate-new "init_comments"

# Накатить все миграции:
just migrate-up

# Откатить последнюю миграцию:
just migrate-down

# Показать статус:
just migrate-status
```

Миграции находятся в директории `db/migrations`. Имя файла генерируется `dbmate` и включает timestamp.

## Разработка

### Автоматическая проверка:

```bash
# Запуск всех проверок сразу
make lint

# Автоматическое исправление форматирования
make format
```

### Тестирование
```bash
# Все тесты
make test
```
